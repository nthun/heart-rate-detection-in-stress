---
title: "Heart rate detection and stress"
author: "Tamas Nagy"
date: "`r Sys.Date()`"
output: 
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r, echo = TRUE, eval = FALSE, include = FALSE}
install.packages(c("tidyverse", "skimr", "lme4", "performance", "sjPlot", "here", "emo", "broom.mixed", "psych", "easystats"))
```


```{r setup, message = FALSE, warning = FALSE, include = FALSE}
library(tidyverse)
library(skimr)
library(lmerTest)
library(performance)
library(sjPlot)
library(broom.mixed)
library(googlesheets4)
library(stringi)
library(gt)
library(ggbeeswarm)
library(correlation)
library(naniar)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 9, fig.height = 6)

theme_set(theme_light())
```


```{r}
# Set parameters
outlier_treshold_sd = 3 # Threshold for outliers in SD
# Column order for model summaries
col_order <- c("est", "ci", "df.error", "stat", "p")
```


```{css}
.main-container {
    max-width: 100%;
}
```

The following analysis report contains the descriptive and inferential statistics for the experiment that investigated how physiological and subjective arousal might be mediated by cardioceptive accuracy.

```{r data_read, include = FALSE}

experiment_data_raw <- 
  googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19AcUrnOCxCH_Huu1yQ4JjEuJWljFRzhFQPYIGU1nhj0/edit#gid=57027312") %>% 
  janitor::clean_names() %>% 
  mutate(code = as.character(code))

phys_data <- read_csv(here::here("data/08_summarised/phys_long.csv"))

```

# Experiment data processing
## Calculate cardioreceptive metrics

Cardioreceptive accuracy, bias, and heart rate perception were calculated using the formulas:  

- ca_ = 1 - |(hr_XXobj - hr_XXszubj)/ hr_XXobj| 
- cb_ = (hr_XXszubj â€“ hr_XXobj) / hr_XXobj 
- hrp = resting_hr_estimated / resting_hr 

XX stands for 25,35,50
With the average calculated for each pearson. 


```{r}
# Calculate cardioceptive metrics
cardio <-
   experiment_data_raw %>%
   transmute(id = stri_trans_general(code, "Latin-ASCII") %>%
                  str_to_lower(),
             ca_25 = 1 - abs((hr_25obj - hr_25szubj) / hr_25obj),
             ca_35 = 1 - abs((hr_35obj - hr_35szubj) / hr_35obj),
             ca_50 = 1 - abs((hr_50obj - hr_50szubj) / hr_50obj),
             cb_25 = (hr_25szubj - hr_25obj) / hr_25obj,
             cb_35 = (hr_35szubj - hr_35obj) / hr_35obj,
             cb_50 = (hr_50szubj - hr_50obj) / hr_50obj,
             ca = (ca_25 + ca_35 + ca_50)/3,
             cb = (cb_25 + cb_35 + cb_50)/3,
             hrp = resting_hr_estimated / resting_hr)

ca_alpha <-
   cardio %>% 
   select(starts_with("ca_")) %>% 
   psych::alpha() %>% 
   .[["total"]] %>% 
   .[["std.alpha"]]

cb_alpha <- 
   cardio %>% 
   select(starts_with("cb_")) %>% 
   psych::alpha() %>% 
   .[["total"]] %>% 
   .[["std.alpha"]]

```

Cronbach alpha for cardioceptive accuracy: `r round(ca_alpha, 2)`
Cronbach alpha for cardioceptive bias: `r round(cb_alpha, 2)` 


```{r}
experiment <-
   experiment_data_raw %>%
   rename(id = code, task_order = mental_order_1_2) %>%
   mutate(
      id = stri_trans_general(id, "Latin-ASCII") %>%
           str_to_lower(),
      sex = recode(sex, `1` = "Male", `2` = "Female"),
      bodyweight = as.numeric(bodyweight),
      bmi = bodyweight / (bodyheight / 100) ^ 2,
      task_order = if_else(task_order == 1,
                           "Mental first",
                           "Physical first") %>%
                   as.factor()) %>%
   select(-starts_with("marker_")) %>%
   left_join(cardio, by = "id")

```

# Sample characteristics

```{r}

experiment %>% 
   select(id, sex, age, task_order, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>% 
   mutate(male = if_else(sex == "Male", 1, 0),
          n = n()) %>% 
   summarise(across(c(n, male, age, stai_s_t0_sum, bmi, bodyfat_percent, resting_hr), 
                    list("_avg" = mean, "_sd" = sd, "_min" = min, "_max" = max), 
                    na.rm = TRUE)) %>% 
   pivot_longer(everything(),
                names_to = c(".value", "parameter"),
                names_pattern = "(.*)__(.*)$") %>% 
   pivot_longer(-parameter) %>% 
   pivot_wider(names_from = "parameter") %>% 
   mutate(avg = if_else(name %in% c("male"), avg * 100, avg),
          sd = if_else(name %in% c("n", "male"), NA_real_, sd),
          min = if_else(name %in% c("n", "male"), NA_real_, min),
          max = if_else(name %in% c("n", "male"), NA_real_, max),
          name = c("N", "Male %", "Mean age in years", "Mean STAI-S Baseline", "Mean BMI in kg/m<sup>2</sup>", "Mean Bodyfat %", "Mean resting HR in bpm")
          ) %>% 
   gt() %>% 
   fmt_number(2:5, decimals = 1, rows = 2:7) %>% 
   fmt_markdown(columns = 1) %>% 
   fmt_missing(everything(), missing_text = "-") %>% 
   cols_merge(columns = c("avg", "sd"), pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("min", "max"), pattern = "{1}-{2}") %>% 
   cols_label("name" = "", "avg" = "Value (SD)", "min" = "Range") %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")


experiment %>% 
   select(age, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>%
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value, fill = name) +
   geom_histogram(show.legend = FALSE) +
   facet_wrap(~name, scales = "free") +
   labs(title = "Histograms of participant characteristics")

```


# Subjective response to stress

We tested if the tasks were perceived as stressful.  

## STAI-S

Controlling for the baseline level of anxiety (measured in the beginning of the session) and the order of the tasks, we found a significant interaction of task and measurement, i.e. the mental task was associated with a STAI-S increase over time, while the physical task did not show a significant change.

```{r}
# Calculate STAI-S reactivity
stai_reactivity <-
   experiment %>% 
   select(id, stai_s_mental_t0_sum,  stai_s_mental_t1_sum, stai_s_physical_t0_sum, stai_s_physical_t1_sum) %>% 
   transmute(id,
             stai_react_cognitive = stai_s_mental_t1_sum - stai_s_mental_t0_sum,
             stai_react_physical = stai_s_physical_t1_sum - stai_s_physical_t0_sum)

   
stai <-
   experiment %>% 
   select(id, ends_with("_sum"), task_order) %>% 
   pivot_longer(cols = -c(id, stai_s_t0_sum, task_order),
                names_to = c("task", "time"),
                names_pattern = "stai_s_(.*)_(.*)_sum") %>% 
   mutate(task = str_to_title(task))

stai_sum <- 
   stai %>% 
   group_by(task, time) %>% 
   summarise(stai_avg = mean(value, na.rm = TRUE),
             stai_sd = sd(value, na.rm = TRUE),
             stai_se = stai_sd/sqrt(n()),
             .groups = "drop")

```

```{r}
# Table
stai_sum %>% 
   select(-stai_se) %>% 
   pivot_wider(names_from = c(time), names_sep = "_",
               values_from = c(stai_avg, stai_sd)) %>% 
   gt() %>% 
   fmt_number(columns = starts_with("stai_"), 
                 decimals = 1) %>% 
   cols_merge(columns = c("stai_avg_t0", "stai_sd_t0"), 
              pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("stai_avg_t1", "stai_sd_t1"), 
              pattern = "{1} ({2})") %>% 
   cols_label(task = "Task",
              stai_avg_t0 = "Pre-stress", 
              stai_avg_t1 = "Post-stress") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey") %>% 
   tab_footnote(footnote = "Values represent the mean (SD) of the STAI-S",
                locations = cells_column_labels(3))

```

---
<div align="center">
```{r}
# Stats
stai %>% 
   filter(task != "baseline") %>% 
   lmer(value ~ task * time + stai_s_t0_sum + task_order + (1|id), 
        data = .) %>% 
   tab_model(dv.labels = "STAI-S", 
             # show.reflvl = TRUE,
             show.aicc = TRUE,
             show.loglik = TRUE#,
             # pred.labels = c("Task:Physical", 
             #                 "Time:Post", 
             #                 "STAI-S Baseline", 
             #                 "Task order",
             #                 "Task:Physical * Time:Post"
             #                 )
             )
```
</div>

---

```{r}
# Visualize
stai_sum %>% 
   ggplot() +
   aes(x = str_to_sentence(time), 
       y = stai_avg, 
       group = task, 
       color = task,
       ymin = stai_avg - stai_se, 
       ymax = stai_avg + stai_se) +
   geom_pointrange() +
   geom_line(size = 1.2, alpha = .6) +
   scale_y_continuous(limits = c(0, NA)) +
   labs(color = "Task",
        title = "Change in STAI-S by task and time",
        subtitle = "STAI-S increased only in the mental stress task.",
        y = "Mean STAI-S (SE)",
        x = "Measurement")


```

## Subjective stress (VAS)

Most of the participants regarded the mental stress more stressful than the physical stress.

```{r}
experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress) %>% 
   pivot_longer(-id) %>% 
   mutate(name = str_remove(name, "_experienced_stress") %>% 
                 str_to_title()) %>% 
   ggplot() +
   aes(y = value, x = name) +
   geom_violin(aes(fill = name), alpha = .8, show.legend = FALSE) +
   geom_line(aes(group = id), alpha = .2) +
   geom_boxplot(show.legend = FALSE, width = .25, outlier.alpha = 0, alpha = .6) +
   geom_quasirandom(groupOnX = TRUE) +
   labs(x = NULL, 
        y = "On a scale of 0-100, how stressful was the task for you?",
        title = "Distribution of Experienced stress by task",
        subtitle = "Physical stress was percieved as less stressful.")

```

# Psychophysiological response to stress

## Outlier detection

We first flag outliers (calculated as outside of `r outlier_treshold_sd` SDs), and check how many can be found in each metric.

```{r}
outlier_flagged <- 
   phys_data %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   group_by(name) %>% 
   mutate(outlier = if_else(abs(scale(value)) > outlier_treshold_sd, TRUE, FALSE),
          .before = value) %>% 
   ungroup()

outlier_flagged %>% 
   group_by(name) %>% 
   summarise( n_outlier = sum(outlier, na.rm = TRUE),
              perc_outlier = mean(outlier, na.rm = TRUE)) %>% 
   arrange(-perc_outlier) %>% 
   gt() %>% 
   fmt_percent(perc_outlier) %>% 
   cols_label(name = "Name",
              n_outlier = "N outlier",
              perc_outlier = "% outlier") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")

outlier_flagged %>% 
   ggplot() +
   aes(x = value, fill = outlier) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   scale_fill_manual(values = c("lightblue", "red")) +
   labs(x = NULL, y = NULL,
        title = "Histogram of the physiological variables",
        subtitle = str_glue("Outliers (red) are identified as values outside of {outlier_treshold_sd} SD"),
        fill = "Outlier")

```

## Data cleaning and processing

We remove outliers, and apply natural log+1 transformation on the values. Values show that the EDA and SCR increase variables should be analyzed using a GLM with exponential distribution.

```{r}

phys_trans <-
   outlier_flagged %>% 
   # Remove outliers
   filter(!outlier) %>% 
   # Create log transformed values
   mutate(lg = log(value + 1)) %>% 
   pivot_wider(names_from = "name",
               values_from = c(value, lg)) %>% 
   set_names(str_remove(names(.), "value_")) %>% 
   # Join participant data
   left_join(select(experiment, 
                    id, sex, age, bodyfat_percent, bmi, task_order,
                    ca, cb, hrp), 
             by = "id")

phys_trans %>% 
   select(starts_with("lg_")) %>% 
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   labs(x = NULL, y = NULL,
        title = "Histogram of the log+1 transformed physiological variables",
        subtitle = "Outliers have been removed")


```

## Calculate physiological reactivity metrics

Reactivity values were calculated for HR, HF%, RMSSD, and EDA, by subtracting the baseline (t0) from the post-stress measurement (t1) for each task.

```{r}
#  Calculate reactivity statistics
reactivity <-
   phys_trans %>% 
   select(id, marker, meanhr, hf_percent, rmssd, eda_avg) %>% 
   pivot_wider(names_from = marker,
               values_from = c("meanhr", "hf_percent", "rmssd","eda_avg")) %>% 
   transmute(id,
             #HR
             meanhr_react_cognitive1 = meanhr_cognitive1 - meanhr_baseline,
             meanhr_react_cognitive2 = meanhr_cognitive2 - meanhr_baseline,
             meanhr_react_physical = meanhr_physical - meanhr_baseline,
             # HF
             hf.percent_react_cognitive1 = hf_percent_cognitive1 - hf_percent_baseline,
             hf.percent_react_cognitive2 = hf_percent_cognitive2 - hf_percent_baseline,
             hf.percent_react_physical = hf_percent_physical - hf_percent_baseline,
             # RMSSD
             rmssd_react_cognitive1 = rmssd_cognitive1 - rmssd_baseline,
             rmssd_react_cognitive2 = rmssd_cognitive2 - rmssd_baseline,
             rmssd_react_physical = rmssd_physical - rmssd_baseline,
             #EDA
             eda.avg_react_cognitive1 = eda_avg_cognitive1 - eda_avg_baseline,
             eda.avg_react_cognitive2 = eda_avg_cognitive2 - eda_avg_baseline,
             eda.avg_react_physical = eda_avg_physical - eda_avg_baseline) %>% 
   left_join(stai_reactivity, by = "id")
   
reactivity %>% 
   pivot_longer(-id) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free", nrow = 4) +
   labs(title = "Reactivity histograms of key metrics")

```

## Missing data analysis

```{r}

phys_data %>% 
   select(eda_avg:hf_abs) %>% 
   group_by() %>% 
   miss_var_summary() %>% 
   print(n = 100)

```


# Analysis of the effects of the tasks on physiological variables
## Heart rate related variables

### Variables
Heart rate and HRV variables were investigated using linear mixed-effect models, with random intercept by person. HRV variables were log+1 transformed to correct for right skew.

### Results 
HR was increased in the physical task compared to baseline.
log(RMSSD) did not change significantly in any task.
log(HF%) and log(HF natural unit) shows a difference from baseline in cognitive1 (increase), and physical task (decrease).
Sex, task order, and bodyfat percent were controlled, and were not significant predictors (age has little variability in the sample).

```{r}
heart_metrics <- c("lg_rmssd", "lg_hf_percent", "lg_hf_n_u", "meanhr")

phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(heart_metrics)) %>% 
   pivot_longer(all_of(heart_metrics)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, 
                      ~lmer(value ~ marker + 
                            task_order + sex + scale(bodyfat_percent) + (1|id), 
                            data = .x))) %>% 
   pull(model) %>% 
   set_names(heart_metrics) %>% 
   tab_model(dv.labels = heart_metrics,
             show.loglik = TRUE,
             show.aicc = TRUE)



```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(heart_metrics)) %>% 
   pivot_longer(all_of(heart_metrics), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of heart rate based variables by task",
        y = "Mean value (SE)",
        x = NULL)
```


## Electrodermal response
### Variables
Raw electrodermal response was decomposed to tonic (SCL) and phasic (SCR) components. SCL was calculated by using the exponential moving average of the EDA values. The SCR values were calculated by taking the difference of EDA and SCL.
   We inspected the EDA, SCL, and SCR averages, and the increase value of these metrics. 
   The averages were analyzed using linear mixed-effect models. The increase values are zero censored and heavily skewed, thus showing a gamma distribution. Therefore, we analyzed these values using generalized linear mixed-effect models, using a Gamma distribution with inverse link. 
Data had to be transformed to be applicable for statistical modeling. Average values were log+1 transformed and centered. Increase values were centered, then multiplied by 1000 for easier interpretation, then 1 is added to values to be larger than zero. 

### Results
EDA and SCL average were significantly larger than baseline. Cognitive tasks were associated with a smaller increase, while the physical task was associated with a larger increase.
For SCR average, none of the tasks exerted a significant effect.
For the increase statistics, only the physical task showed significantly larger value than baseline.

Sex, task order, and bodyfat percent were controlled, and were not significant predictors (age has little variability in the sample).


```{r}

skin_avg <- c("lg_eda_avg", "lg_scl_avg", "lg_scr_avg")
skin_increase <- c("eda_increase", "scl_increase", "scr_increase")

# LMEMs for average values
skin_avg_mod <-
   phys_trans %>% 
   select(id, task_order, marker, sex, bodyfat_percent, all_of(skin_avg)) %>% 
   pivot_longer(all_of(skin_avg), values_drop_na = TRUE) %>% 
   # Center values
   mutate(std_value = scale(value, scale = FALSE)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, ~lmer(std_value ~ marker +
                                  task_order + sex + scale(bodyfat_percent) +
                                  (1|id),
                                  data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_avg)

# GLMEMs for increase values
skin_increase_mod <-
   phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, all_of(skin_increase)) %>% 
   pivot_longer(all_of(skin_increase), values_drop_na = TRUE) %>% 
   # Center, multiply by 1000, and add 1
   mutate(std_value = scale(value, scale = FALSE)*1000+1) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate( model = map(data, ~glmer(std_value ~ marker + task_order + sex +
                                                scale(bodyfat_percent) + (1|id),
                                    family = Gamma(link = "inverse"),
                                    data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_increase)

tab_model( c(skin_avg_mod, skin_increase_mod),
           dv.labels = c(skin_avg, skin_increase),
           show.loglik = TRUE,
           show.aicc = TRUE)

```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(skin_avg), all_of(skin_increase)) %>% 
   pivot_longer(c(all_of(skin_avg), all_of(skin_increase)), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   scale_color_viridis_d() +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of electrodermal variables by task",
        y = "Mean value (SE)",
        x = NULL)
```

```{r eval=FALSE, include=FALSE}
# Check if the order influenced the metrics
# For average metrics, it did not. SCR showed a strange pattern.
# For increase metrics, the first task always increased the metric more
# Overall, EDA or SCL average should be used as the sypmathetic marker.

phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(skin_avg), all_of(skin_increase)) %>% 
   pivot_longer(c(all_of(skin_avg), all_of(skin_increase)), values_drop_na = TRUE) %>%
   group_by(name, task_order, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, color = task_order, 
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange(alpha = .6) +
   geom_line(aes(group = interaction(name, task_order)), size = 1.2, alpha = .6) +
   scale_color_viridis_d() +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of electrodermal variables by task",
        y = "Mean value (SE)",
        x = NULL,
        color = "Task order")
```

## Reactivity measures
### Variables
Reactivity (task - baseline) values were calculated for EDA average, HF%, RMSSD, HR average, and STAI. 

### Results


```{r}


reactivity %>% 
   pivot_longer(-id, values_drop_na = TRUE) %>% 
   group_by(name) %>% 
   summarise(avg = mean(value),
             se = sd(value)/sqrt(n())) %>% 
   separate(name, 
            into = c("metric", "marker"), 
            sep = "_",
            extra = "merge") %>% 
   mutate(marker = str_remove_all(marker, "react_")) %>% 
   ggplot() +
   aes(x = marker, y = avg, ymin = avg - se, ymax = avg + se, 
       group = metric) +
   geom_pointrange() +
   geom_line(aes(color = metric), size = 1.2, alpha = .6, 
             show.legend = FALSE) +
   geom_hline(yintercept = 0, color = "red", lty = "dashed") +
   facet_wrap(~metric, scales = "free") +
   labs(title = "Reactivity measures: Difference from baseline by task",
        subtitle = "Zero (dashed red line) shows baseline",
        x = NULL,
        y = "Mean (SD)")

```


# Hypothesis tests

<!-- TODO: Calculate change metrics by task -->

## H1
There is a medium level association between cardioceptive accuracy [cardioceptive_accuracy] and cardiovascular reactivity (positive for heart rate [ΔHRmental, ΔHRphysical], electrodermal response [SCRmental; SCRphysical]; negative for vagal component of heart rate variability [ΔRMSSDmental, ΔHFmental; ΔRMSSDphysical, ΔHFphysical]) in both conditions (mental; physical)


### Verbatim solution

We calculated the reactivity values, and correlated those with cardioceptive accuracy/bias, and heart rate perception.
```{r}
react_vars <-
   c(
      "meanhr_cognitive1",
      "meanhr_cognitive2",
      "meanhr_physical",
      "hf.percent_cognitive1",
      "hf.percent_cognitive2",
      "hf.percent_physical",
      "rmssd_cognitive1",
      "rmssd_cognitive2",
      "rmssd_physical",
      "eda.avg_cognitive1",
      "eda.avg_cognitive2",
      "eda.avg_physical",
      "stai_cognitive",
      "stai_physical"
   )

experiment %>% 
   select(id, ca, cb, hrp) %>% 
   left_join(reactivity, by = "id") %>% 
   rename_with(~str_remove(., "react_")) %>% 
   correlation(p_adjust = "fdr", 
               select2 = c("ca", "cb", "hrp"),
               select = all_of(react_vars)) %>% 
   arrange(Parameter2) %>% 
   print_html()
```

### Same thing, but more contemporary approach

We built linear mixed-effect models with random intercept by person to investigate if cardioceptive accuracy/bias/heart rate perception moderates the response to stress in any of the tasks.

```{r}
# Create moderation models
cardioceptive_models <-
   phys_trans %>% 
   select(id, 
          marker, meanhr, lg_hf_percent, lg_rmssd, lg_eda_avg, 
          ca, cb, hrp) %>% 
   pivot_longer(meanhr:lg_eda_avg) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(ca_model = map(data, 
                         ~lmer(scale(value) ~ marker * scale(ca) +
                              (1|id), data = .x)),
          cb_model = map(data, 
                         ~lmer(scale(value) ~ marker * scale(cb) +
                              (1|id), data = .x)),
          hrp_model = map(data, 
                         ~lmer(scale(value) ~ marker * scale(hrp) +
                              (1|id), data = .x)))

cardioceptive_models$ca_model %>% 
   tab_model(dv.labels = cardioceptive_models$name,
             title = "Models for cardioceptive accuracy",
             col.order = col_order,
             show.aicc = TRUE, show.stat = TRUE, show.df = TRUE)

cardioceptive_models$cb_model %>% 
   tab_model(dv.labels = cardioceptive_models$name,
             title = "Models for cardioceptive bias",
             col.order = col_order,
             show.aicc = TRUE, show.stat = TRUE, show.df = TRUE)

cardioceptive_models$hrp_model %>% 
   tab_model(dv.labels = cardioceptive_models$name,
             title = "Models for heart rate perception",
             col.order = col_order,
             show.aicc = TRUE, show.stat = TRUE, show.df = TRUE)


```

```{r}
phys_trans %>% 
   select(meanhr, marker, ca, cb, hrp) %>% 
   pivot_longer(ca:hrp) %>% 
   ggplot() +
   aes(x = value, y = meanhr, color = marker) +
   geom_point(alpha = .6) +
   facet_wrap(~marker) +
   geom_smooth(method = "lm", alpha = .6, size = 1.2, 
               se = FALSE, alpha = .6) +
   scale_color_viridis_d() +
      labs(title = "Association between cardioceptive metrics and mean HR",
        subtitle = "The correlation is similar in all tasks",
        caption = "Notes: ca: cadioceptive accuracy, cb: cardioceptive bias, hrp: heart rate perception",
        color = "Task",
        y = "Mean HR (bpm)",
        x = NULL) +
   facet_wrap(~name, scales = "free_x")
```

## H2
Cardioceptive accuracy [cardioceptive_accuracy] moderates the association between objective [ΔHRmental, SCRmental, ΔRMSSDmental, ΔHFmental; ΔHRphysical, SCRphysical, ΔRMSSDphysical, ΔHFphysical] and subjective reactions to stress [mental_experienced_stress; physical_experienced_stress / STAI-S_mental_after – STAI-S_mental_before; STAI-S_physical_after - STAI-S_physical_before]; higher cardioceptive accuracy is related to a stronger association

We fitted linear regressions on the reactivity score for each metric (HR mean, HF%, RMSSD, and EDA mean) for each task (cognitive1, cognitive2, and physical). We investigated if the STAI-S change in the respective task had a significant association with the change metric, and if the cardioceptive accuracy or heart rate perception moderated the association. We included sex, body fat percent, and task order as covariates.

We found a significant positive association between the reactivity of RMSSD in the cognitive task and the change in STAI. The higher the perceived stress was, the more the RMSSD increased in the cognitive task.

We found a significant negative association between the reactivity of EDA mean in the cognitive task and the change in STAI. The higher the perceived stress was, the more the EDA mean decreased in the cognitive task.


```{r}
hypo2 <-
   reactivity %>% 
   # Put all reactivity metrics and cardioceptive metrics together
   left_join(select(experiment, id, ca, hrp, bodyfat_percent, sex, task_order), by = "id") %>%
   # Create a redundant dataset to run several regressions at once
   pivot_longer(-c(id, ca, hrp, bodyfat_percent, sex, stai_react_cognitive, stai_react_physical, task_order),
                names_to = c("metric","task"),
                names_pattern = "(.*)_react_(.*)") %>% 
   group_by(metric, task) %>% 
   # Scale all numeric vaiarables (by metric and task)
   mutate(across(c(stai_react_cognitive:bodyfat_percent, value), 
                 ~scale(.x) %>% 
                  as.numeric())) %>% 
   nest() %>% 
   # Create several models for different cardioceptive metrics and tasks
   mutate(ca_cognitive_mod = map(data, 
                            ~lm(value ~ stai_react_cognitive * ca +
                                        bodyfat_percent + sex + task_order, 
                                data = .x)),
          hrp_cognitive_mod = map(data, 
                            ~lm(value ~ stai_react_cognitive * hrp +
                                        bodyfat_percent + sex + task_order, 
                                data = .x)),
          ca_physical_mod = map(data, 
                            ~lm(value ~ stai_react_physical * ca +
                                         bodyfat_percent + sex + task_order, 
                                data = .x)),
          hrp_physical_mod = map(data, 
                            ~lm(value ~ stai_react_physical * hrp +
                                        bodyfat_percent + sex + task_order, 
                                data = .x))
   ) %>% 
   # Drop all models where the physiological and subjective task doesn't mach
   pivot_longer(ca_cognitive_mod:hrp_physical_mod) %>% 
   filter((str_detect(task, "cognitive") & str_detect(name, "cognitive")) |
          (str_detect(task, "physical") & str_detect(name, "physical"))) %>% 
   unite("metric_task", metric, task)

# Print all models
hypo2 %>% 
   pull(value) %>% 
   set_names(hypo2$metric_task) %>% 
   map(tidy, conf.int = TRUE) %>% 
   map(~mutate(.x, cr = case_when(str_detect(term, "ca$") ~ "ca", 
                                     str_detect(term, "hrp$") ~ "hrp"))) %>% 
   map(~fill(.x, cr, .direction = "up")) %>% 
   bind_rows(.id = "model") %>% 
   separate(model, into = c("metric", "task"), sep = "_") %>% 
   group_by(metric, task, cr) %>% 
   select(metric, task, cr, term, estimate, std.error, conf.low, conf.high, statistic, p.value) %>% 
   gt() %>% 
   fmt_number(c("estimate", "std.error", "conf.low", "conf.high"), decimals = 2) %>%
   fmt_number(c("statistic", "p.value"), decimals = 3) %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey",
               row_group.background.color = "lightgrey", 
               row_group.font.weight = "bold", 
               row.striping.include_table_body = TRUE,
               row.striping.background_color = "#EEEEEE"
   )

```

```{r}
hypo2 %>% 
   filter(metric_task %in% c("rmssd_cognitive1") &
          str_detect(name, "ca")) %>% 
   select(-value) %>% 
   unnest(data) %>% 
   ggplot() +
   aes(x = stai_react_cognitive, y = value) +
   geom_point() +
   geom_smooth(method = "lm") +
   labs(title = "The association beween STAI change and RMSSD reactivity in the cognitive task",
        x = "STAI-S change",
        y = "RMSSD reactivity")

hypo2 %>% 
   filter(metric_task %in% c("eda.avg_cognitive1") &
          str_detect(name, "ca")) %>% 
   select(-value) %>% 
   unnest(data) %>% 
   ggplot() +
   aes(x = stai_react_cognitive, y = value) +
   geom_point() +
   geom_smooth(method = "lm") +
   labs(title = "The association beween STAI change and EDA mean reactivity in the cognitive task",
        x = "STAI-S change",
        y = "EDA mean reactivity")
```

## H3
Perceived stress in both conditions [mental_experienced_stress; physical_experienced_stress / STAI-S_mental_after – STAI-S_mental_before; STAI-S_physical_after - STAI-S_physical_before] is predicted by cardioceptive accuracy [cardioceptive_accuracy], physiological reactions [ΔHRmental, SCRmental, ΔRMSSDmental, ΔHFmental; ΔHRphysical, SCRphysical, ΔRMSSDphysical, ΔHFphysical], and stress related expectations [mental_expected_stress; physical_expected_stress]


```{r}

```

## H4 
Perceived HR in both conditions [mental_experienced_HR_change; physical_experienced_HR_change] is predicted by actual change [ΔHRmental, ΔHRphysical] and HR-related expectations [mental_expected_HR_change; physical_expected_HR_change] in both conditions


```{r}

hypo4 <-
   reactivity %>% 
   select(id, starts_with("meanhr_")) %>% 
   # Put HR reactivity metrics expected and experienced change together
   left_join(select(experiment, id, 
                    physical_expected_hr_change,
                    physical_experienced_hr_change,
                    mental_expected_hr_change,
                    mental_experienced_hr_change, 
                    bodyfat_percent, sex, task_order), by = "id") %>% 
   # Create a redundant dataset to run several regressions at once
   pivot_longer(c(meanhr_react_cognitive1:meanhr_react_physical),
                names_to = c("metric","task"),
                names_pattern = "(.*)_react_(.*)") %>% 
      group_by(metric, task) %>% 
   # Scale all numeric vaiarables (by metric and task)
   mutate(across(c(physical_expected_hr_change:bodyfat_percent, value), 
                 ~scale(.x) %>% 
                  as.numeric())) %>% 
   nest() %>% 
   # Create different models
   mutate(physical_mod = map(data, 
                            ~lm(value ~ physical_expected_hr_change +
                                        physical_experienced_hr_change +
                                        bodyfat_percent + sex + task_order, 
                                data = .x)),
          cognitive_mod = map(data, 
                            ~lm(value ~ mental_expected_hr_change +
                                        mental_experienced_hr_change +
                                        bodyfat_percent + sex + task_order, 
                                data = .x))
          ) %>% 
   pivot_longer(cognitive_mod:physical_mod) %>% 
   filter((str_detect(task, "cognitive") & str_detect(name, "cognitive")) |
          (str_detect(task, "physical") & str_detect(name, "physical"))) %>% 
   unite("metric_task", metric, task)

hypo4 %>% 
   pull(value) %>% 
   set_names(hypo4$metric_task) %>% 
   map(tidy, conf.int = TRUE) %>% 
   bind_rows(.id = "model") %>% 
   separate(model, into = c("metric", "task"), sep = "_") %>% 
   group_by(metric, task) %>% 
   select(metric, task, term, estimate, std.error, conf.low, conf.high, statistic, p.value) %>% 
   gt() %>% 
   fmt_number(c("estimate", "std.error", "conf.low", "conf.high"), decimals = 2) %>%
   fmt_number(c("statistic", "p.value"), decimals = 3) %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey",
               row_group.background.color = "lightgrey", 
               row_group.font.weight = "bold", 
               row.striping.include_table_body = TRUE,
               row.striping.background_color = "#EEEEEE"
   )


```

## H5
Acuity of perception of heartbeat [cardioceptive_bias] and heart rate [cardioceptive_accuracy_HR] are positively associated

There is a positive correlation between cardioceptive accuracy, caridoceptive bias, but not between cardioceptive metrics and heart rate perception.

```{r}
phys_trans %>% 
   distinct(id, .keep_all = TRUE) %>%
   correlation(
               select = c("ca", "cb", "hrp"),
               p_adjust = "fdr") %>% 
   print_html()

```

