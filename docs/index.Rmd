---
title: "Heart rate detection and stress"
author: "Tamas Nagy"
date: "`r Sys.Date()`"
output: 
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r, echo = TRUE, eval = FALSE, include = FALSE}
install.packages(c("tidyverse", "skimr", "lme4", "performance", "sjPlot", "here", "emo", "broom.mixed", "psych", "easystats"))
```


```{r setup, message = FALSE, warning = FALSE, include = FALSE}
library(tidyverse)
library(skimr)
library(lmerTest)
library(performance)
library(sjPlot)
library(broom.mixed)
library(googlesheets4)
library(stringi)
library(gt)
library(ggbeeswarm)
library(correlation)
library(naniar)
library(patchwork)
library(skimr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 9, fig.height = 6)

theme_set(theme_light())
```


```{r}
# Set parameters
outlier_treshold_sd = 3 # Threshold for outliers in SD
# Column order for model summaries
col_order <- c("est", 
               # "ci", 
               "se",
               # "df.error", 
               "stat", 
               "p")

renamed_markers <-
  c("baseline" = "Baseline",
    "physical" = "Handgrip",
    "cognitive" = "N-back",
    "mental" = "N-back")

cardioceptive_names <-
  c(ca = "Cardioceptive accuracy",
    hrp = "Heart rate perception")

phys_metrics <- 
  tribble(~name, ~metric,
         "meanhr", "Mean HR",
         "lg_hf_percent", "HF% (log)",
         "lg_rmssd", "RMSSD (log)",
         "lg_eda_avg", "Mean EDA (log)") %>% 
  mutate(metric = fct_inorder(metric))

skin_avg <- c("lg_eda_avg", "lg_scl_avg", "lg_scr_avg")
skin_increase <- c("eda_increase", "scl_increase", "scr_increase")
heart_metrics <- c("lg_rmssd", "lg_hf_percent", "lg_hf_n_u", "meanhr")

```


```{css}
.main-container {
    max-width: 100%;
}
```

The following analysis report contains the descriptive and inferential statistics for the experiment that investigated how physiological and subjective arousal might be mediated by cardioceptive accuracy.

To access the previous version, with cognitive tasks separately:
https://nthun.github.io/heart-rate-detection-in-stress/preliminary_results.html 

```{r data_read, include = FALSE}

experiment_data_raw <- 
  googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19AcUrnOCxCH_Huu1yQ4JjEuJWljFRzhFQPYIGU1nhj0/edit#gid=57027312") %>% 
  janitor::clean_names() %>% 
  mutate(code = as.character(code))

phys_data <- 
  read_csv(here::here("data/08_summarised/phys_long_merged.csv")) %>% 
  mutate(marker = recode(marker, !!!renamed_markers))

```

# Experiment data processing
## Calculate cardioreceptive metrics

Cardioreceptive accuracy, bias, and heart rate perception were calculated using the formulas:  

- ca_ = 1 - |(hr_XXobj - hr_XXszubj)/ hr_XXobj| 
- hrp = resting_hr_estimated / resting_hr 

XX stands for 25,35,50
With the average calculated for each pearson. 


```{r}
# Calculate cardioceptive metrics
cardio <-
   experiment_data_raw %>%
   transmute(id = stri_trans_general(code, "Latin-ASCII") %>%
                  str_to_lower(),
             ca_25 = 1 - abs((hr_25obj - hr_25szubj) / hr_25obj),
             ca_35 = 1 - abs((hr_35obj - hr_35szubj) / hr_35obj),
             ca_50 = 1 - abs((hr_50obj - hr_50szubj) / hr_50obj),
             ca = (ca_25 + ca_35 + ca_50)/3,
             hrp = resting_hr_estimated / resting_hr,
             hrp_group = cut_number(hrp, 
                                n = 3, 
                                labels = c("Low HRP",
                                           "Medium HRP",
                                           "High HRP"),
                                ordered_result = TRUE)
)

ca_alpha <-
   cardio %>% 
   select(starts_with("ca_")) %>% 
   psych::alpha() %>% 
   .[["total"]] %>% 
   .[["std.alpha"]]

```

Cronbach alpha for cardioceptive accuracy: `r round(ca_alpha, 2)`


```{r}
experiment <-
   experiment_data_raw %>%
   rename(id = code, task_order = mental_order_1_2) %>%
   mutate(
      id = stri_trans_general(id, "Latin-ASCII") %>%
           str_to_lower(),
      sex = recode(sex, `1` = "Male", `2` = "Female"),
      bodyweight = as.numeric(bodyweight),
      bmi = bodyweight / (bodyheight / 100) ^ 2,
      task_order = if_else(task_order == 1,
                           "Cognitive first",
                           "Physical first") %>%
                   as.factor()) %>%
   select(-starts_with("marker_")) %>%
   left_join(cardio, by = "id")

```

# Sample characteristics

```{r}
experiment %>%
  select(male = sex,
         age,
         stai_s_t0_sum,
         bmi,
         bodyfat_percent,
         max_grip_strength,
         resting_hr) %>%
  mutate(male = if_else(male == "Male", 100, 0),
         n = n(),
         .before = 1) %>%
  skim() %>%
  select( name = skim_variable,
          mean = numeric.mean,
          sd = numeric.sd,
          min = numeric.p0,
          max = numeric.p100,
          Distribution = numeric.hist) %>%
  mutate(name = c("N",
                  "Male %",
                  "Mean age (years)",
                  "Mean STAI-S baseline",
                  "Mean BMI (kg/m<sup>2</sup>)",
                  "Mean bodyfat %",
                  "Mean max grip strength (kg)",
                  "Mean resting HR (bpm)")) %>%
  gt() %>%
  fmt_number(c(mean, sd, min, max), decimals = 1, rows = 2:8) %>%
  fmt_markdown(columns = 1) %>%
  cols_merge(columns = c("mean", "sd"), pattern = "{1} ({2})") %>%
  cols_merge(columns = c("min", "max"), pattern = "{1} - {2}") %>%
  cols_label("name" = "",
             "mean" = "Value (SD)",
             "min" = "Range")

```


# Subjective response to stress

We tested if the tasks were perceived as stressful.  

## STAI-S

Controlling for the baseline level of anxiety (measured in the beginning of the session) and the order of the tasks, we found a significant interaction of task and measurement, i.e. the cognitive task was associated with a STAI-S increase over time, while the physical task did not show a significant change.

```{r}
# Calculate STAI-S reactivity
stai_reactivity <-
   experiment %>% 
   select(id, stai_s_mental_t0_sum,  stai_s_mental_t1_sum, stai_s_physical_t0_sum, stai_s_physical_t1_sum) %>% 
   transmute(id,
             `stai_react_N-back` = stai_s_mental_t1_sum - stai_s_mental_t0_sum,
             stai_react_Handgrip = stai_s_physical_t1_sum - stai_s_physical_t0_sum)

   
stai <-
   experiment %>% 
   select(id, ends_with("_sum"), task_order) %>% 
   pivot_longer(cols = -c(id, stai_s_t0_sum, task_order),
                names_to = c("task", "time"),
                names_pattern = "stai_s_(.*)_(.*)_sum") %>% 
   mutate(task = recode(task, !!!renamed_markers))

stai_sum <-
   stai %>% 
   group_by(task, time) %>% 
   summarise(stai_avg = mean(value, na.rm = TRUE),
             stai_sd = sd(value, na.rm = TRUE),
             stai_se = stai_sd/sqrt(n())) %>% 
   mutate(stai_prop = stai_avg/first(stai_avg)) %>% 
   ungroup()

```

```{r}
# Table
stai_sum %>% 
   select(-stai_se) %>% 
   pivot_wider(names_from = c(time), names_sep = "_",
               values_from = c(stai_avg, stai_sd, stai_prop)) %>% 
   select(-stai_prop_t0) %>% 
   gt() %>% 
   fmt_number(columns = starts_with("stai_"), 
                 decimals = 1) %>% 
   fmt_percent(stai_prop_t1, decimals = 1) %>% 
   cols_merge(columns = ends_with("_t0"), 
              pattern = "{1} ± {2}") %>% 
   cols_merge(columns = ends_with("_t1"), 
              pattern = "{1} ± {2} ({3})") %>% 
   cols_label(task = "Task",
              stai_avg_t0 = "Pre-stress", 
              stai_avg_t1 = "Post-stress") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey") %>%
   tab_footnote(footnote = "Values represent the mean (SD) of the STAI-S",
                locations = cells_column_labels(3))

```

---
<div align="center">
```{r}
# Stats
stai %>% 
   filter(task != "baseline") %>% 
   lmer(value ~ task * time + stai_s_t0_sum + task_order + (1|id), 
        data = .) %>% 
   tab_model(dv.labels = "STAI-S", 
             show.aicc = TRUE,
             show.stat = TRUE,
             show.df = TRUE,
             show.std = TRUE)
```
</div>

---

```{r}
# Visualize
stai_sum %>% 
   mutate(time = recode(time, t0 = "Baseline", t1 = "Task")) %>% 
   ggplot() +
   aes(x = time, 
       y = stai_avg, 
       group = task, 
       color = task,
       ymin = stai_avg - stai_se, 
       ymax = stai_avg + stai_se) +
   geom_errorbar(width = .1, alpha = .7, color = "gray50") +
   geom_point() +
   geom_line(size = 1.2, alpha = .6) +
   # scale_y_continuous(limits = c(0, NA)) +
   labs(color = "Task",
        # title = "Change in STAI-S by task and time",
        # subtitle = "STAI-S increased only in the cognitive stress task.",
        y = "Mean STAI-S (SEM)",
        x = NULL) +
  theme(panel.grid = element_blank())


```

## Subjective stress (VAS)

Most of the participants regarded the cognitive stress more stressful than the physical stress.

```{r}
experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress) %>% 
   pivot_longer(-id) %>% 
   mutate(name = str_remove(name, "_experienced_stress") %>% 
                 recode(!!!renamed_markers)) %>% 
   ggplot() +
   aes(y = value, x = name) +
   geom_violin(aes(fill = name), alpha = .8, show.legend = FALSE) +
   geom_line(aes(group = id), alpha = .2) +
   geom_boxplot(show.legend = FALSE, width = .25, outlier.alpha = 0, alpha = .6) +
   geom_quasirandom(groupOnX = TRUE) +
   labs(x = NULL, 
        y = "On a scale of 0-100, how stressful was the task for you?",
        title = "Distribution of Experienced stress by task",
        subtitle = "Physical stress was percieved as less stressful.")

```

The subjective stress measure also showed, that participants regarded the mental stressor to be more stressful than the physical stressor.

```{r}
experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress, stai_s_t0_sum, task_order) %>% 
   pivot_longer(-c(id, stai_s_t0_sum, task_order)) %>% 
   mutate(name = str_remove(name, "_experienced_stress") %>% 
                 recode(!!!renamed_markers)) %>% 
  lmer(value ~ name + stai_s_t0_sum + task_order + (1|id), data = .) %>% 
     tab_model(dv.labels = "STAI-S", 
             show.stat = TRUE,
             show.df = TRUE,
             show.std = TRUE)

experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress) %>% 
   pivot_longer(-id) %>% 
   mutate(name = str_remove(name, "_experienced_stress") %>% 
                 recode(!!!renamed_markers)) %>% 
  t.test(value ~ name, data = ., paired = TRUE)

```

# Psychophysiological response to stress

## Outlier detection

We first flag outliers (calculated as outside of `r outlier_treshold_sd` SDs), and check how many can be found in each metric.

```{r}
outlier_flagged <- 
   phys_data %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   group_by(name) %>% 
   mutate(outlier = if_else(abs(scale(value)) > outlier_treshold_sd, TRUE, FALSE),
          .before = value) %>% 
   ungroup()

outlier_flagged %>% 
   group_by(name) %>% 
   summarise( n_outlier = sum(outlier, na.rm = TRUE),
              perc_outlier = mean(outlier, na.rm = TRUE)) %>% 
   arrange(-perc_outlier) %>% 
   gt() %>% 
   fmt_percent(perc_outlier) %>% 
   cols_label(name = "Name",
              n_outlier = "N outlier",
              perc_outlier = "% outlier") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")

outlier_flagged %>% 
   ggplot() +
   aes(x = value, fill = outlier) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   scale_fill_manual(values = c("lightblue", "red")) +
   labs(x = NULL, y = NULL,
        title = "Histogram of the physiological variables",
        subtitle = str_glue("Outliers (red) are identified as values outside of {outlier_treshold_sd} SD"),
        fill = "Outlier")

```

## Data cleaning and processing

We remove outliers, and apply natural log+1 transformation on the values. Values show that the EDA and SCR increase variables should be analyzed using a GLM with exponential distribution.

```{r}

phys_trans <-
   outlier_flagged %>% 
   # Remove outliers
   filter(!outlier) %>% 
   # Create log transformed values
   mutate(lg = log(value + 1)) %>% 
   pivot_wider(names_from = "name",
               values_from = c(value, lg)) %>% 
   set_names(str_remove(names(.), "value_")) %>% 
   # Join participant data
   left_join(select(experiment, 
                    id, sex, age, bodyfat_percent, bmi, task_order,
                    ca, hrp), 
             by = "id")

phys_trans %>% 
   select(starts_with("lg_")) %>% 
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   labs(x = NULL, y = NULL,
        title = "Histogram of the log+1 transformed physiological variables",
        subtitle = "Outliers have been removed")


```

## Calculate physiological reactivity metrics

Reactivity values were calculated for HR, HF%, RMSSD, and EDA, by subtracting the baseline (t0) from the post-stress measurement (t1) for each task.

```{r}
#  Calculate reactivity statistics
reactivity <-
   phys_trans %>% 
   select(id, marker, meanhr, hf_percent, rmssd, eda_avg) %>% 
   pivot_wider(names_from = marker,
               values_from = c("meanhr", "hf_percent", "rmssd","eda_avg")) %>% 
   transmute(id,
             #HR
             `meanhr_react_N-back` = `meanhr_N-back` - meanhr_Baseline,
             meanhr_react_Handgrip = meanhr_Handgrip - meanhr_Baseline,
             # HF
             `hf.percent_react_N-back` = `hf_percent_N-back` - hf_percent_Baseline,
             hf.percent_react_Handgrip = hf_percent_Handgrip - hf_percent_Baseline,
             # RMSSD
             `rmssd_react_N-back` = `rmssd_N-back` - rmssd_Baseline,
             rmssd_react_Handgrip = rmssd_Handgrip - rmssd_Baseline,
             #EDA
             `eda.avg_react_N-back` = `eda_avg_N-back` - eda_avg_Baseline,
             eda.avg_react_Handgrip = eda_avg_Handgrip - eda_avg_Baseline) %>% 
   left_join(stai_reactivity, by = "id")
   
reactivity %>% 
   pivot_longer(-id) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free", nrow = 4) +
   labs(title = "Reactivity histograms of key metrics")

```

## Missing data analysis

```{r}
phys_data %>% 
   select(eda_avg:hf_abs) %>% 
   group_by() %>% 
   miss_var_summary() %>% 
   print_html()

```


# Analysis of the effects of the tasks on physiological variables
## Heart rate related variables

### Variables
Heart rate and HRV variables were investigated using linear mixed-effect models, with random intercept by person. HRV variables were log+1 transformed to correct for right skew.

### Results 
HR was increased in the physical task compared to baseline.
log(RMSSD) did not change significantly in any task.
log(HF%) and log(HF natural unit) shows a difference from baseline in cognitive (increase), and physical task (decrease).
Sex, task order, and bodyfat percent were controlled, and were not significant predictors (age has little variability in the sample).

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(heart_metrics)) %>% 
   pivot_longer(all_of(heart_metrics)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, 
                      ~lmer(value ~ marker + 
                            task_order + sex + scale(bodyfat_percent) + (1|id), 
                            data = .x))) %>% 
   pull(model) %>% 
   set_names(heart_metrics) %>% 
   tab_model(dv.labels = heart_metrics,
             show.loglik = TRUE,
             show.aicc = TRUE)



```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(heart_metrics)) %>% 
   pivot_longer(all_of(heart_metrics), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of heart rate based variables by task",
        y = "Mean value (SE)",
        x = NULL)
```


## Electrodermal response
### Variables
Raw electrodermal response was decomposed to tonic (SCL) and phasic (SCR) components. SCL was calculated by using the exponential moving average of the EDA values. The SCR values were calculated by taking the difference of EDA and SCL.
   We inspected the EDA, SCL, and SCR averages, and the increase value of these metrics. 
   The averages were analyzed using linear mixed-effect models. The increase values are zero censored and heavily skewed, thus showing a gamma distribution. Therefore, we analyzed these values using generalized linear mixed-effect models, using a Gamma distribution with inverse link. 
Data had to be transformed to be applicable for statistical modeling. Average values were log+1 transformed and centered. Increase values were centered, then multiplied by 1000 for easier interpretation, then 1 is added to values to be larger than zero. 

### Results
EDA and SCL average were significantly larger than baseline. Cognitive tasks were associated with a smaller increase, while the physical task was associated with a larger increase.
For SCR average, none of the tasks exerted a significant effect.
For the increase statistics, only the physical task showed significantly larger value than baseline.

Sex, task order, and bodyfat percent were controlled, and were not significant predictors (age has little variability in the sample).


```{r}
# LMEMs for average values
skin_avg_mod <-
   phys_trans %>% 
   select(id, task_order, marker, sex, bodyfat_percent, all_of(skin_avg)) %>% 
   pivot_longer(all_of(skin_avg), values_drop_na = TRUE) %>% 
   # Center values
   mutate(std_value = scale(value, scale = FALSE)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, ~lmer(std_value ~ marker +
                                  task_order + sex + scale(bodyfat_percent) +
                                  (1|id),
                                  data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_avg)

# GLMEMs for increase values
skin_increase_mod <-
   phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, all_of(skin_increase)) %>% 
   pivot_longer(all_of(skin_increase), values_drop_na = TRUE) %>% 
   # Center, multiply by 1000, and add 1
   mutate(std_value = scale(value, scale = FALSE)*1000+1) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate( model = map(data, ~glmer(std_value ~ marker + task_order + sex +
                                                scale(bodyfat_percent) + (1|id),
                                    family = Gamma(link = "inverse"),
                                    data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_increase)

tab_model( c(skin_avg_mod, skin_increase_mod),
           dv.labels = c(skin_avg, skin_increase),
           show.loglik = TRUE,
           show.aicc = TRUE)

```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(skin_avg), all_of(skin_increase)) %>% 
   pivot_longer(c(all_of(skin_avg), all_of(skin_increase)), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   scale_color_viridis_d() +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of electrodermal variables by task",
        y = "Mean value (SE)",
        x = NULL) +
  theme(panel.grid = element_blank())
```

```{r eval=FALSE, include=FALSE}
# Check if the order influenced the metrics
# For average metrics, it did not. SCR showed a strange pattern.
# For increase metrics, the first task always increased the metric more
# Overall, EDA or SCL average should be used as the sypmathetic marker.

phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(skin_avg), all_of(skin_increase)) %>% 
   pivot_longer(c(all_of(skin_avg), all_of(skin_increase)), values_drop_na = TRUE) %>%
   group_by(name, task_order, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, color = task_order, 
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange(alpha = .6) +
   geom_line(aes(group = interaction(name, task_order)), size = 1.2, alpha = .6) +
   scale_color_viridis_d() +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of electrodermal variables by task",
        y = "Mean value (SE)",
        x = NULL,
        color = "Task order")
```

## Reactivity measures
### Variables
Reactivity (task - baseline) values were calculated for EDA average, HF%, RMSSD, HR average, and STAI. 

### Results


```{r}
reactivity %>% 
   pivot_longer(-id, values_drop_na = TRUE) %>% 
   group_by(name) %>% 
   summarise(avg = mean(value),
             se = sd(value)/sqrt(n())) %>% 
   separate(name, 
            into = c("metric", "marker"), 
            sep = "_",
            extra = "merge") %>% 
   mutate(marker = str_remove_all(marker, "react_")) %>% 
   ggplot() +
   aes(x = marker, y = avg, ymin = avg - se, ymax = avg + se, 
       group = metric) +
   geom_pointrange() +
   geom_line(aes(color = metric), size = 1.2, alpha = .6, 
             show.legend = FALSE) +
   geom_hline(yintercept = 0, color = "red", lty = "dashed") +
   facet_wrap(~metric, scales = "free") +
   labs(title = "Reactivity measures: Difference from baseline by task",
        subtitle = "Zero (dashed red line) shows baseline",
        x = NULL,
        y = "Mean (SD)")

```


# Hypothesis tests

## H1
There is a medium level association between cardioceptive accuracy [cardioceptive_accuracy] and cardiovascular reactivity (positive for heart rate [ΔHRmental, ΔHRphysical], electrodermal response [SCRmental; SCRphysical]; negative for vagal component of heart rate variability [ΔRMSSDmental, ΔHFmental; ΔRMSSDphysical, ΔHFphysical]) in both conditions (mental; physical)

### Verbatim solution
```{r eval=FALSE, include=FALSE}

# 
# We calculated the reactivity values, and correlated those with cardioceptive accuracy/bias, and heart rate perception.

react_vars <-
   c(
      "meanhr_N-back",
      "meanhr_Handgrip",
      "hf.percent_N-back",
      "hf.percent_Handgrip",
      "rmssd_N-back",
      "rmssd_Handgrip",
      "eda.avg_N-back",
      "eda.avg_Handgrip",
      "stai_N-back",
      "stai_Handgrip"
   )

experiment %>% 
   select(id, ca, hrp) %>% 
   left_join(reactivity, by = "id") %>% 
   rename_with(~str_remove(., "react_")) %>% 
   correlation(p_adjust = "fdr", 
               select2 = c("ca", "hrp"),
               select = all_of(react_vars)) %>% 
   arrange(Parameter2) %>% 
   print_html()
```

We built linear mixed-effect models with random intercept by person to investigate if cardioceptive accuracy/heart rate perception moderates the response to stress in any of the tasks.

We did not find a relationship between cardioceptive accuracy and physiological reactivity measures (HR, RMSSD, HF%, EDA) in any of the tasks. However, CA was negatively associated with HR and positively with lgRMSSD.
Similarly, heart rate perception was negatively associated with HR and positively with lgRMSSD, but did not moderate the reaction to stress.

### LMEM solution
```{r}
# Create moderation models
cardioceptive_models <-
   phys_trans %>% 
   select(id, 
          marker, meanhr, lg_hf_percent, lg_rmssd, lg_eda_avg, 
          ca, hrp) %>% 
   pivot_longer(meanhr:lg_eda_avg) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(ca_model = map(data, 
                         ~lmer(scale(value) ~ marker * scale(ca) +
                              (1|id), data = .x)),
          hrp_model = map(data, 
                         ~lmer(scale(value) ~ marker * scale(hrp) +
                              (1|id), data = .x))) %>% 
  left_join(phys_metrics, ., by = "name") %>% 
  select(-name)

cardioceptive_models$ca_model %>% 
   tab_model(dv.labels = cardioceptive_models$metric,
             title = "Models for cardioceptive accuracy",
             col.order = col_order,
             file = "docs/s2a.html",
             show.se = TRUE,
             show.stat = TRUE, show.df = TRUE)

cardioceptive_models$hrp_model %>% 
   tab_model(dv.labels = cardioceptive_models$metric,
             title = "Models for heart rate perception",
             col.order = col_order,
             file = "docs/s2b.html",
             show.se = TRUE,
             show.stat = TRUE, show.df = TRUE)


```

```{r}
phys_trans %>% 
   select(meanhr, lg_rmssd, marker, ca, hrp) %>% 
   pivot_longer(ca:hrp, 
                names_to = "cardio_metric", 
                values_to = "cardio_value") %>% 
   pivot_longer(meanhr:lg_rmssd, 
                names_to = "name",
                values_to = "value") %>% 
   mutate(cardio_metric = recode(cardio_metric, !!!cardioceptive_names)) %>% 
   left_join(phys_metrics, by = "name") %>% 
   ggplot() +
   aes(x = cardio_value, y = value, color = marker) +
   geom_point(alpha = .6) +
   facet_wrap(~marker) +
   geom_smooth(method = "lm", 
               size = 1.2, 
               se = FALSE, 
               alpha = .6) +
   scale_color_viridis_d() +
      labs(title = "Association between cardioceptive metrics and mean HR",
        subtitle = "The correlation is similar in all tasks",
        color = "Task",
        y = NULL,
        x = NULL) +
   facet_grid(metric~cardio_metric, scales = "free") +
  theme(panel.grid = element_blank())
```

## H2
Cardioceptive accuracy [cardioceptive_accuracy] moderates the association between objective [ΔHRmental, SCRmental, ΔRMSSDmental, ΔHFmental; ΔHRphysical, SCRphysical, ΔRMSSDphysical, ΔHFphysical] and subjective reactions to stress [mental_experienced_stress; physical_experienced_stress / STAI-S_mental_after – STAI-S_mental_before; STAI-S_physical_after - STAI-S_physical_before]; higher cardioceptive accuracy is related to a stronger association

We fitted linear regressions on the reactivity score for each metric (HR mean, HF%, RMSSD, and EDA mean) for each task (cognitive and physical). We investigated if the STAI-S change in the respective task had a significant association with the change metric, and if the cardioceptive accuracy or heart rate perception moderated the association. We included sex, body fat percent, and task order as covariates.

We found a significant negative association between the reactivity of EDA mean in the cognitive task and the change in STAI. The higher the perceived stress was, the more the EDA mean decreased in the cognitive task.


```{r}
hypo2 <-
   reactivity %>% 
   # Put all reactivity metrics and cardioceptive metrics together
   left_join(select(experiment, id, ca, hrp, bodyfat_percent, hrp_group, sex, task_order), by = "id") %>%
   # Create a redundant dataset to run several regressions at once
   pivot_longer(-c(id, ca, hrp, hrp_group, bodyfat_percent, sex, `stai_react_N-back`, stai_react_Handgrip, task_order),
                names_to = c("metric","task"),
                names_pattern = "(.*)_react_(.*)") %>% 
   group_by(metric, task) %>% 
   # Scale all numeric vaiarables (by metric and task)
   mutate(across(c(`stai_react_N-back`:bodyfat_percent, value), 
                 ~scale(.x) %>% 
                  as.numeric())) %>% 
   nest() %>% 
   # Create several models for different cardioceptive metrics and tasks
   mutate(`ca_N-back_mod` = map(data, 
                            ~lm(`stai_react_N-back` ~ value * ca +
                                        bodyfat_percent + sex + task_order, 
                                data = .x)),
          `hrp_N-back_mod` = map(data, 
                            ~lm(`stai_react_N-back` ~ value * hrp +
                                        bodyfat_percent + sex + task_order, 
                                data = .x)),
          ca_Handgrip_mod = map(data, 
                            ~lm(stai_react_Handgrip ~ value * ca +
                                         bodyfat_percent + sex + task_order, 
                                data = .x)),
          hrp_Handgrip_mod = map(data, 
                            ~lm(stai_react_Handgrip ~ value * hrp +
                                        bodyfat_percent + sex + task_order, 
                                data = .x))
   ) %>% 
   # Drop all models where the physiological and subjective task doesn't mach
   pivot_longer(`ca_N-back_mod`:hrp_Handgrip_mod) %>% 
   filter((str_detect(task, "N-back") & str_detect(name, "N-back")) |
          (str_detect(task, "Handgrip") & str_detect(name, "Handgrip"))) %>% 
   unite("metric_task", metric, task) %>% 
   arrange(name)

# Print all models
hypo2 %>% 
   pull(value) %>% 
   set_names(hypo2$metric_task) %>% 
   map(tidy, conf.int = TRUE) %>% 
   map(~mutate(.x, cr = case_when(str_detect(term, "ca$") ~ "ca", 
                                  str_detect(term, "hrp$") ~ "hrp"))) %>% 
   map(~fill(.x, cr, .direction = "up")) %>% 
   bind_rows(.id = "model") %>% 
   separate(model, into = c("metric", "task"), sep = "_") %>% 
   mutate(term = str_replace(term, "value", metric)) %>% 
   group_by(metric, task, cr) %>% 
   select(metric, task, cr, term, estimate, std.error, 
          #conf.low, conf.high, 
          statistic, p.value) %>% 
   gt() %>% 
   fmt_number(c("estimate", "std.error", "statistic"
                #"conf.low", "conf.high"
                ), 
                decimals = 2) %>%
   fmt_number("p.value", decimals = 3) %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey",
               row_group.background.color = "lightgrey", 
               row_group.font.weight = "bold", 
               row.striping.include_table_body = TRUE,
               row.striping.background_color = "#EEEEEE"
   )

```

```{r}
# In tab_models
# CA
hypo2 %>% 
  slice(1:8) %>% 
  pull(value) %>% 
  set_names(hypo2$metric_task[1:8]) %>% 
  tab_model(dv.labels = hypo2$metric_task[1:8],
            title = "Models for cardioceptive accuracy",
            col.order = col_order,
            file = "docs/h2ca.html",
            show.se = TRUE,
            show.stat = TRUE, 
            show.df = TRUE
            )

# HRP
hypo2 %>% 
  slice(9:16) %>% 
  pull(value) %>% 
  set_names(hypo2$metric_task[9:16]) %>% 
  tab_model(dv.labels = hypo2$metric_task[9:16],
            title = "Models for heart rate perception",
            col.order = col_order,
            file = "docs/h2hrp.html",
            show.se = TRUE,
            show.stat = TRUE, 
            show.df = TRUE)

```

### Figure: CA/HRP moderates the association of objective and subjective change metrics

```{r}
reactivity %>% 
  select(id, `meanhr_react_N-back`, meanhr_react_Handgrip,
        `stai_react_N-back`, stai_react_Handgrip) %>%
  left_join(select(experiment, id, ca, hrp, hrp_group), by = "id") %>%
  pivot_longer(`meanhr_react_N-back`:stai_react_Handgrip,
                names_to = c("name", "task"),
                names_pattern = "(.*_react)_(.*)") %>% 
  pivot_wider(names_from = "name", values_from = "value") %>% 
  ggplot() +
  aes(y = stai_react, x = meanhr_react, color = hrp_group) +
  geom_hline(yintercept = 0, lty = "dashed", alpha = .2) +
  geom_vline(xintercept = 0, lty = "dashed", alpha = .2) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm", se = FALSE, alpha = .7) +
  scale_color_brewer(palette = "Blues") +
  facet_wrap(~task, scales = "free_x") +
  labs(color = "HRP group",
       x = "HR change",
       y = "STAI change") +
  theme(legend.position = "bottom", panel.grid = element_blank())
  
```



```{r}
hypo2 %>% 
   filter(metric_task %in% c("eda.avg_N-back") &
          str_detect(name, "ca")) %>% 
   select(-value) %>% 
   unnest(data) %>% 
   ggplot() +
   aes(x = `stai_react_N-back`, y = value) +
   geom_point() +
   geom_smooth(method = "lm") +
   labs(title = "The association beween STAI change and EDA mean reactivity in the N-back task",
        x = "STAI-S change",
        y = "EDA mean reactivity")
```

## H3
Perceived stress in both conditions [mental_experienced_stress; physical_experienced_stress / STAI-S_mental_after – STAI-S_mental_before; STAI-S_physical_after - STAI-S_physical_before] is predicted by cardioceptive accuracy [cardioceptive_accuracy], physiological reactions [ΔHRmental, SCRmental, ΔRMSSDmental, ΔHFmental; ΔHRphysical, SCRphysical, ΔRMSSDphysical, ΔHFphysical], and stress related expectations [mental_expected_stress; physical_expected_stress]

We fitted linear regressions for each task (N-back and physical) separately. We investigated if physiological changes, cardioceptive accuracy, or expected HR change predicted STAI-S change in the respective tasks. We used task order as a covariate. 

We found no associations between cardioceptive accuracy and STAI-S change.
Expected HR change did predict STAI-S change in all N-back tasks.
From the physiological measures, only RMSSD predicted STAI-S change.

```{r}
hypo3 <-
   reactivity %>% 
   left_join(select(experiment, 
                    id, ca, hrp, 
                    task_order,
                    physical_expected_hr_change,
                    mental_expected_hr_change),
                    by = "id") %>%
   pivot_longer(`meanhr_react_N-back`:eda.avg_react_Handgrip,
                names_pattern = "(.*)_react_(.*)",
                names_to = c("metric", "task")) %>% 
   group_by(metric, task) %>% 
   # Scale all numeric vaiarables (by metric and task)
   mutate(across(c(`stai_react_N-back`:ca,                  
                 physical_expected_hr_change:mental_expected_hr_change,
                 value), 
                 ~scale(.x) %>% 
                  as.numeric())) %>%    
   nest() %>% 
   mutate(`N-back_stai_react` = map(data, 
                                     ~lm(`stai_react_N-back` ~ ca + 
                                         mental_expected_hr_change + 
                                         task_order +
                                         value,
                                         data = .x)),
          Handgrip_stai_react = map(data, 
                                     ~lm(stai_react_Handgrip ~ ca + 
                                         physical_expected_hr_change + 
                                         task_order + 
                                         value,
                                         data = .x))) %>% 
   pivot_longer(`N-back_stai_react`:Handgrip_stai_react) %>% 
      filter((str_detect(task, "N-back") & str_detect(name, "N-back")) |
          (str_detect(task, "Handgrip") & str_detect(name, "Handgrip"))) %>% 
   mutate(name = str_replace(name, "N-back", task)) %>% 
   mutate(name = str_replace(name, "react", metric)) %>% 
   ungroup()
   
hypo3 %>% 
   pull(value) %>% 
   set_names(hypo3$name) %>% 
   map_dfr(tidy, conf.int = TRUE, .id = "model") %>% 
   group_by(model) %>% 
   mutate(metric = str_match(model, ".*_(.*)$")[,2],
          term = str_replace(term, "value", metric)) %>% 
   select(model, term, estimate, std.error, conf.low, conf.high, statistic, p.value) %>% 
   gt() %>% 
   fmt_number(c("estimate", "std.error", "conf.low", "conf.high"), decimals = 2) %>%
   fmt_number(c("statistic", "p.value"), decimals = 3) %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey",
               row_group.background.color = "lightgrey", 
               row_group.font.weight = "bold", 
               row.striping.include_table_body = TRUE,
               row.striping.background_color = "#EEEEEE"
   )   

hypo3 %>% 
   pull(value) %>% 
   set_names(hypo3$name) %>% 
   map_dfr(glance, conf.int = TRUE, .id = "model") %>% 
   arrange(model) %>% 
   gt() %>% 
   fmt_number(c(r.squared:statistic, logLik:deviance), decimals = 2) %>% 
   fmt_number(p.value, decimals = 3)

```

## H4 
Perceived HR in both conditions [mental_experienced_HR_change; physical_experienced_HR_change] is predicted by actual change [ΔHRmental, ΔHRphysical] and HR-related expectations [mental_expected_HR_change; physical_expected_HR_change] in both conditions

We fitted linear regressions for each task (cognitive and physical) separately. We investigated if actual (ECG measured) HR change in the respective tasks predicted subjective HR change, and if expectations predicted subjective HR change better. We included sex, body fat percent, and task order as covariates.

We found that actual HR change did not predict the experienced HR change in any of the tasks. However, expected HR change significantly predicted subjective HR change in all tasks.


```{r}
# Build models
hypo4 <-
   reactivity %>% 
   select(id, starts_with("meanhr_")) %>% 
   # Put HR reactivity metrics expected and experienced change together
   left_join(select(experiment, id, 
                    physical_expected_hr_change,
                    physical_experienced_hr_change,
                    mental_expected_hr_change,
                    mental_experienced_hr_change, 
                    bodyfat_percent, sex, task_order), by = "id") %>% 
   # Create a redundant dataset to run several regressions at once
   pivot_longer(c(`meanhr_react_N-back`:meanhr_react_Handgrip),
                names_to = c("metric","task"),
                names_pattern = "(.*)_react_(.*)",
                values_to = "hr_reactivity") %>% 
      group_by(metric, task) %>% 
   # Scale all numeric vaiarables (by metric and task)
   mutate(across(c(physical_expected_hr_change:bodyfat_percent, hr_reactivity), 
                 ~scale(.x) %>% 
                  as.numeric())) %>% 
   nest() %>% 
   # Create different models with and without expected variable
   mutate(Handgrip_by_expected = map(data, 
                            ~lm(physical_experienced_hr_change ~ 
                                physical_expected_hr_change +
                                bodyfat_percent + sex + task_order, 
                                data = .x)),
          `N-back_by_expected` = map(data, 
                            ~lm(mental_experienced_hr_change ~ 
                                mental_expected_hr_change +
                                bodyfat_percent + sex + task_order, 
                                data = .x)),
          Handgrip_by_react = map(data, 
                            ~lm(physical_experienced_hr_change ~ 
                                hr_reactivity +
                                bodyfat_percent + sex + task_order, 
                                data = .x)),
          `N-back_by_react` = map(data, 
                            ~lm(mental_experienced_hr_change ~ 
                                hr_reactivity +
                                bodyfat_percent + sex + task_order, 
                                data = .x))
          ) %>% 
   pivot_longer(Handgrip_by_expected:`N-back_by_react`) %>% 
   filter((str_detect(task, "N-back") & str_detect(name, "N-back")) |
          (str_detect(task, "Handgrip") & str_detect(name, "Handgrip"))) %>% 
   mutate(name = str_replace(name, "N-back", task)) %>% 
   ungroup()

hypo4 %>% 
   pull(value) %>% 
   set_names(hypo4$name) %>% 
   map(tidy, conf.int = TRUE) %>% 
   bind_rows(.id = "model") %>% 
   group_by(model) %>% 
   select(model, term, estimate, std.error, conf.low, conf.high, statistic, p.value) %>% 
   gt() %>% 
   fmt_number(c("estimate", "std.error", "conf.low", "conf.high"), decimals = 2) %>%
   fmt_number(c("statistic", "p.value"), decimals = 3) %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey",
               row_group.background.color = "lightgrey", 
               row_group.font.weight = "bold", 
               row.striping.include_table_body = TRUE,
               row.striping.background_color = "#EEEEEE"
   )


```

```{r}
# Plot associations
hypo4_plots <- 
   hypo4 %>% 
   distinct(task, .keep_all = TRUE) %>% 
   select(task, data) %>% 
   mutate(physical_ract_plot = map(data,
                                   ~ggplot(.x) +
                                    aes(x = hr_reactivity,
                                        y = physical_experienced_hr_change) +
                                    geom_point(alpha = .3) +
                                    geom_smooth(method = "lm")),
          cognitive_ract_plot = map(data,
                                   ~ggplot(.x) +
                                    aes(x = hr_reactivity,
                                        y = mental_experienced_hr_change) +
                                    geom_point(alpha = .3) +
                                    geom_smooth(method = "lm")),
          physical_expected_plot = map(data,
                                   ~ggplot(.x) +
                                    aes(x = physical_expected_hr_change,
                                        y = physical_experienced_hr_change) +
                                    geom_point(alpha = .3) +
                                    geom_smooth(method = "lm")),
          cognitive_expected_plot = map(data,
                                   ~ggplot(.x) +
                                    aes(x = mental_expected_hr_change,
                                        y = mental_experienced_hr_change) +
                                    geom_point(alpha = .3) +
                                    geom_smooth(method = "lm"))
          ) %>% 
   pivot_longer(physical_ract_plot:cognitive_expected_plot,
                values_to = "plots") %>% 
   filter((str_detect(task, "N-back") & str_detect(name, "cognitive")) |
          (str_detect(task, "Handgrip") & str_detect(name, "physical"))) %>% 
   mutate(name = str_replace(name, "cognitive", task)) %>% 
   ungroup() %>% 
   mutate(plots = map2(plots, name,
                       ~.x +
                       labs(subtitle = .y)))
   

wrap_plots(hypo4_plots$plots) + 
   plot_annotation(title = "Association of experienced HR change with actual and expected HR change in different tasks",
                   subtitle = "Actual HR change did not predict the experienced HR change in any of the tasks.\nHowever, expected HR change significantly predicted subjective HR change in all tasks.")

```


## H5
Acuity of perception of heartbeat [cardioceptive_bias] and heart rate [cardioceptive_accuracy_HR] are positively associated

There is a positive correlation between cardioceptive accuracy, caridoceptive bias, but not between cardioceptive metrics and heart rate perception.

```{r}
phys_trans %>% 
   distinct(id, .keep_all = TRUE) %>%
   correlation(
               select = c("ca", "hrp"),
               p_adjust = "none") %>% 
   print_html()

```

# Sandbox

## Visualize phys changes
```{r}

phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          meanhr, lg_hf_percent, lg_rmssd, lg_eda_avg) %>% 
   pivot_longer(meanhr:lg_eda_avg, values_drop_na = TRUE) %>%
   left_join(phys_metrics, by = "name") %>% 
   group_by(metric, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = metric,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_errorbar(width = .2, alpha = .5) +
   geom_point(aes(color = metric), show.legend = FALSE) +
   geom_line(aes(color = metric), 
             size = 1.2, alpha = .6, 
             show.legend = FALSE) +
   facet_wrap(~metric, scales = "free_y") +
   labs(y = "Mean value (SEM)",
        x = NULL) +
   theme(panel.grid = element_blank())
```

## Phys changes stats

```{r}

phys_trans %>% 
   select(id, marker, task_order, sex, bodyfat_percent, 
          all_of(phys_metrics$name)) %>% 
   pivot_longer(all_of(phys_metrics$name)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, 
                      ~lmer(value ~ marker + 
                            task_order + sex + scale(bodyfat_percent) + (1|id), 
                            data = .x))) %>% 
   pull(model) %>% 
   set_names(phys_metrics$name) %>% 
   tab_model(dv.labels = phys_metrics$metric, 
             pred.labels = c("(Intercept)",
                             "Task [N-back]",
                             "Task [Handgrip]",
                             "Task order [Physical first]",
                             "Sex [Male]",
                             "Bodyfat %"),
             string.stat = "t",
             string.ci = "95% CI", 
             # file = "tables/phys_change.html",
             show.stat = TRUE
             ) 
  
```

## Change  stats in %
```{r}

phys_trans %>% 
  select(id, marker, one_of(phys_metrics$name)) %>% 
  pivot_longer(-c(id, marker)) %>% 
  group_by(name, marker) %>% 
  summarise(avg = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE)) %>% 
  mutate(prop_change = avg / first(avg) %>% round(2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = marker,
              values_from = c(avg, sd, prop_change)) %>% 
  left_join(phys_metrics, by = "name") %>% 
  relocate(metric) %>% 
  select(-name) %>% 
  arrange(metric) %>% 
  gt() %>% 
  fmt_percent(starts_with("prop_"), decimals = 1) %>% 
  fmt_number(matches("^avg.*|^sd.*"), decimals = 2) %>%
  cols_merge(columns = ends_with("_Baseline"),
             pattern = "{1} ± {2}") %>% 
  cols_merge(columns = ends_with("_Handgrip"),
             pattern = "{1} ± {2} ({3})") %>% 
  cols_merge(columns = ends_with("_N-Back"),
             pattern = "{1} ± {2} ({3})") %>% 
  cols_label(metric = "",
             avg_Baseline = "Baseline",
             avg_Handgrip = "Handgrip",
             `avg_N-back` = "N-back") %>% 
  cols_align(metric, align = "left")


  
```

