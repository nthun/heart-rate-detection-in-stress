---
title: "Heart rate detection and stress"
author: "Tamas Nagy"
date: "`r Sys.Date()`"
output: 
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r, echo = TRUE, eval = FALSE, include = FALSE}
install.packages(c("tidyverse", "skimr", "lme4", "performance", "sjPlot", "here", "emo", "broom.mixed"))
```


```{r setup, message = FALSE, warning = FALSE, include = FALSE}
library(tidyverse)
library(skimr)
library(lmerTest)
library(performance)
library(sjPlot)
library(broom.mixed)
library(googlesheets4)
library(stringi)
library(gt)
library(ggbeeswarm)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 9, fig.height = 6)

theme_set(theme_light())
```


```{r}
# Set parameters
outlier_treshold_sd = 3 # Threshold for outliers in SD
```


```{css}
.main-container {
    max-width: 100%;
}
```

The following analysis report contains the descriptive and inferential statistics for the experiment that investigated how physiological and subjective arousal might be mediated by cardioceptive accuracy.

```{r data_read, include = FALSE}

experiment_data_raw <- 
  googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19AcUrnOCxCH_Huu1yQ4JjEuJWljFRzhFQPYIGU1nhj0/edit#gid=57027312") %>% 
  janitor::clean_names() %>% 
  mutate(code = as.character(code))

phys_data <- read_csv(here::here("data/08_summarised/phys_long.csv"))

```


```{r}
experiment <-
  experiment_data_raw %>%
  rename(id = code, task_order = mental_order_1_2) %>% 
  mutate(id = stri_trans_general(id, "Latin-ASCII") %>% 
              str_to_lower(),
         sex = recode(sex, `1` = "Male", `2` = "Female"),
         bodyweight = as.numeric(bodyweight),
         bmi = bodyweight / (bodyheight/100)^2,
         task_order = if_else(task_order == 1, 
                              "Mental first", 
                              "Physical first") %>% 
                       as.factor()) %>% 
  select(-starts_with("marker_"))
```

# Sample characteristics
```{r}

experiment %>% 
   select(id, sex, age, task_order, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>% 
   mutate(male = if_else(sex == "Male", 1, 0),
          n = n()) %>% 
   summarise(across(c(n, male, age, stai_s_t0_sum, bmi, bodyfat_percent, resting_hr), 
                    list("_avg" = mean, "_sd" = sd, "_min" = min, "_max" = max), 
                    na.rm = TRUE)) %>% 
   pivot_longer(everything(),
                names_to = c(".value", "parameter"),
                names_pattern = "(.*)__(.*)$") %>% 
   pivot_longer(-parameter) %>% 
   pivot_wider(names_from = "parameter") %>% 
   mutate(avg = if_else(name %in% c("male"), avg * 100, avg),
          sd = if_else(name %in% c("n", "male"), NA_real_, sd),
          min = if_else(name %in% c("n", "male"), NA_real_, min),
          max = if_else(name %in% c("n", "male"), NA_real_, max),
          name = c("N", "Male %", "Mean age in years", "Mean STAI-S Baseline", "Mean BMI in kg/m<sup>2</sup>", "Mean Bodyfat %", "Mean resting HR in bpm")
          ) %>% 
   gt() %>% 
   fmt_number(2:5, decimals = 1, rows = 2:7) %>% 
   fmt_markdown(columns = 1) %>% 
   fmt_missing(everything(), missing_text = "-") %>% 
   cols_merge(columns = c("avg", "sd"), pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("min", "max"), pattern = "{1}-{2}") %>% 
   cols_label("name" = "", "avg" = "Value (SD)", "min" = "Range") %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")


experiment %>% 
   select(age, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>%
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value, fill = name) +
   geom_histogram(show.legend = FALSE) +
   facet_wrap(~name, scales = "free") +
   labs(title = "Histograms of participant characteristics")

```


# Subjective response to stress

We tested if the tasks were perceived as stressful.  

## STAI-S

Controlling for the baseline level of anxiety (measured in the beginning of the session) and the order of the tasks, we found a significant interaction of task and measurement, i.e. the mental task was associated with a STAI-S increase over time, while the physical task did not show a significant change.

```{r}

stai <-
   experiment %>% 
   select(id, ends_with("_sum"), task_order) %>% 
   pivot_longer(cols = -c(id, stai_s_t0_sum, task_order)) %>% 
   extract(name, 
           into = c("task", "time"), 
           regex = "stai_s_(.*)_(.*)_sum") %>% 
   mutate(task = str_to_title(task))

stai_sum <- 
   stai %>% 
   group_by(task, time) %>% 
   summarise(stai_avg = mean(value, na.rm = TRUE),
             stai_sd = sd(value, na.rm = TRUE),
             stai_se = stai_sd/sqrt(n()),
             .groups = "drop")

```

```{r}
# Table
stai_sum %>% 
   select(-stai_se) %>% 
   pivot_wider(names_from = c(time), names_sep = "_",
               values_from = c(stai_avg, stai_sd)) %>% 
   gt() %>% 
   fmt_number(columns = starts_with("stai_"), 
                 decimals = 1) %>% 
   cols_merge(columns = c("stai_avg_t0", "stai_sd_t0"), 
              pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("stai_avg_t1", "stai_sd_t1"), 
              pattern = "{1} ({2})") %>% 
   cols_label(task = "Task",
              stai_avg_t0 = "Pre-stress", 
              stai_avg_t1 = "Post-stress") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey") %>% 
   tab_footnote(footnote = "Values represent the mean (SD) of the STAI-S",
                locations = cells_column_labels(3))

```

---
<div align="center">
```{r}
# Stats
stai %>% 
   filter(task != "baseline") %>% 
   lmer(value ~ task * time + stai_s_t0_sum + task_order + (1|id), 
        data = .) %>% 
   tab_model(dv.labels = "STAI-S", 
             # show.reflvl = TRUE,
             show.aicc = TRUE,
             show.loglik = TRUE#,
             # pred.labels = c("Task:Physical", 
             #                 "Time:Post", 
             #                 "STAI-S Baseline", 
             #                 "Task order",
             #                 "Task:Physical * Time:Post"
             #                 )
             )
```
</div>

---

```{r}
# Visualize
stai_sum %>% 
   ggplot() +
   aes(x = str_to_sentence(time), 
       y = stai_avg, 
       group = task, 
       color = task,
       ymin = stai_avg - stai_se, 
       ymax = stai_avg + stai_se) +
   geom_pointrange() +
   geom_line(size = 1.2, alpha = .6) +
   scale_y_continuous(limits = c(0, NA)) +
   labs(color = "Task",
        title = "Change in STAI-S by task and time",
        subtitle = "STAI-S increased only in the mental stress task.",
        y = "Mean STAI-S (SE)",
        x = "Measurement")


```

## Subjective stress (VAS)

Most of the participants regarded the mental stress more stressful than the physical stress.

```{r}
experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress) %>% 
   pivot_longer(-id) %>% 
   mutate(name = str_remove(name, "_experienced_stress") %>% 
                 str_to_title()) %>% 
   ggplot() +
   aes(y = value, x = name) +
   geom_violin(aes(fill = name), alpha = .8, show.legend = FALSE) +
   geom_line(aes(group = id), alpha = .2) +
   geom_boxplot(show.legend = FALSE, width = .25, outlier.alpha = 0, alpha = .6) +
   geom_quasirandom(groupOnX = TRUE) +
   labs(x = NULL, 
        y = "On a scale of 0-100, how stressful was the task for you?",
        title = "Distribution of Experienced stress by task",
        subtitle = "Physical stress was percieved as less stressful.")

```

# Psychophysiological response to stress

## Outlier detection

We first flag outliers (calculated as outside of `r outlier_treshold_sd` SDs), and check how many can be found in each metric.

```{r}
outlier_flagged <- 
   phys_data %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   group_by(name) %>% 
   mutate(outlier = if_else(abs(scale(value)) > outlier_treshold_sd, TRUE, FALSE),
          .before = value) %>% 
   ungroup()

outlier_flagged %>% 
   group_by(name) %>% 
   summarise( n_outlier = sum(outlier, na.rm = TRUE),
              perc_outlier = mean(outlier, na.rm = TRUE)) %>% 
   arrange(-perc_outlier) %>% 
   gt() %>% 
   fmt_percent(perc_outlier) %>% 
   cols_label(name = "Name",
              n_outlier = "N outlier",
              perc_outlier = "% outlier") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")

outlier_flagged %>% 
   ggplot() +
   aes(x = value, fill = outlier) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   scale_fill_manual(values = c("lightblue", "red")) +
   labs(x = NULL, y = NULL,
        title = "Histogram of the physiological variables",
        subtitle = str_glue("Outliers (red) are identified as values outside of {outlier_treshold_sd} SD"),
        fill = "Outlier")

```

## Data cleaning

We remove outliers, and apply natural log+1 transformation on the values. Values show that the EDA and SCR increase variables should be analyzed using a GLM with exponential distribution.

```{r}
phys_trans <-
   outlier_flagged %>% 
   # Remove outliers
   filter(!outlier) %>% 
   # Create log transformed values
   mutate(lg = log(value + 1)) %>% 
   pivot_wider(names_from = "name",
               values_from = c(value, lg)) %>% 
   set_names(str_remove(names(.), "value_")) %>% 
   # Join participant data
   left_join(select(experiment, 
                    id, sex, age, bodyfat_percent, bmi, task_order), 
             by = "id")

phys_trans %>% 
   select(starts_with("lg_")) %>% 
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   labs(x = NULL, y = NULL,
        title = "Histogram of the log+1 transformed physiological variables",
        subtitle = "Outliers have been removed")


```

# Analysis of the effects of the tasks on physiological variables
## Heart rate related variables

### Variables
Heart rate and HRV variables were investigated using linear mixed-effect models, with random intercept by person. HRV variables were log+1 transformed to correct for right skew.

### Results 
HR was increased in the physical task compared to baseline.
log(RMSSD) did not change significantly in any task.
log(HF%) and log(HF natural unit) shows a difference from baseline in cognitive1 (increase), and physical task (decrease).
Sex, task order, and BMI were controlled, and were not significant predictors (age has little variability in the sample).

```{r}
heart_metrics <- c("lg_rmssd", "lg_hf_percent", "lg_hf_n_u", "meanhr")

phys_trans %>% 
   select(id, marker, task_order, sex, bmi, heart_metrics) %>% 
   pivot_longer(all_of(heart_metrics)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, 
                      ~lmer(value ~ marker + 
                            task_order + sex + scale(bmi) + (1|id), 
                            data = .x))) %>% 
   pull(model) %>% 
   set_names(heart_metrics) %>% 
   tab_model(dv.labels = heart_metrics,
             show.loglik = TRUE,
             show.aicc = TRUE)

```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bmi, heart_metrics) %>% 
   pivot_longer(all_of(heart_metrics), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of heart rate based variables by task",
        y = "Mean value (SE)",
        x = NULL)
```


## Electrodermal response
### Variables
Raw electrodermal response was decomposed to tonic (SCL) and phasic (SCR) components. SCL was calculated by using the exponential moving average of the EDA values. The SCR values were calculated by taking the difference of EDA and SCL.
   We inspected the EDA, SCL, and SCR averages, and the increase value of these metrics. 
   The averages were analyzed using linear mixed-effect models. The increase values are zero censored and heavily skewed, thus showing a gamma distribution. Therefore, we analyzed these values using generalized linear mixed-effect models, using a Gamma distribution with inverse link. 
Data had to be transformed to be applicable for statistical modeling. Average values were log+1 transformed and centered. Increase values were centered, then multiplied by 1000 for easier interpretation, then 1 is added to values to be larger than zero. 

### Results
EDA and SCL average were significantly larger than baseline. Cognitive tasks were associated with a smaller increase, while the physical task was associated with a larger increase.
For SCR average, none of the tasks exerted a significant effect.
For the increase statistics, only the physical task showed significantly larger value than baseline.

Sex, task order, and BMI were controlled, and were not significant predictors (age has little variability in the sample).


```{r}

skin_avg <- c("lg_eda_avg", "lg_scl_avg", "lg_scr_avg")
skin_increase <- c("eda_increase", "scl_increase", "scr_increase")

# LMEMs for average values
skin_avg_mod <-
   phys_trans %>% 
   select(id, task_order, marker, sex, bmi, skin_avg) %>% 
   pivot_longer(all_of(skin_avg), values_drop_na = TRUE) %>% 
   # Center values
   mutate(std_value = scale(value, scale = FALSE)) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate(model = map(data, ~lmer(std_value ~ marker +
                                  task_order + sex + scale(bmi) +
                                  (1|id),
                                  data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_avg)

# GLMEMs for increase values
skin_increase_mod <-
   phys_trans %>% 
   select(id, marker, task_order, sex, bmi, skin_increase) %>% 
   pivot_longer(all_of(skin_increase), values_drop_na = TRUE) %>% 
   # Center, multiply by 1000, and add 1
   mutate(std_value = scale(value, scale = FALSE)*1000+1) %>% 
   group_by(name) %>% 
   nest() %>% 
   mutate( model = map(data, ~glmer(std_value ~ marker + task_order + sex +
                                                scale(bmi) + (1|id),
                                    family = Gamma(link = "inverse"),
                                    data = .x))) %>% 
   pull(model) %>% 
   set_names(skin_increase)

tab_model( c(skin_avg_mod, skin_increase_mod),
           dv.labels = c(skin_avg, skin_increase),
           show.loglik = TRUE,
           show.aicc = TRUE)

```

```{r}
phys_trans %>% 
   select(id, marker, task_order, sex, bmi, skin_avg, skin_increase) %>% 
   pivot_longer(c(skin_avg, skin_increase), values_drop_na = TRUE) %>%
   group_by(name, marker) %>% 
   summarise(avg_value = mean(value),
             se_value = sd(value)/sqrt(n()), 
             .groups = "drop") %>% 
   ggplot() +
   aes(x = marker, y = avg_value, group = name,
       ymin = avg_value - se_value, ymax = avg_value + se_value) +
   geom_pointrange() +
   geom_line(aes(color = name), size = 1.2, alpha = .6, show.legend = FALSE) +
   scale_color_viridis_d() +
   facet_wrap(~name, scales = "free_y") +
   labs(title = "Mean values of electrodermal variables by task",
        y = "Mean value (SE)",
        x = NULL)
```
