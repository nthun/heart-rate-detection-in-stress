---
title: "Heart rate detection and stress"
author: "Tamas Nagy"
date: "`r Sys.Date()`"
output: 
  html_document:
   theme: spacelab
   code_download: true
   toc: true
   toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r, echo = TRUE, eval = FALSE, include = FALSE}
install.packages(c("tidyverse", "skimr", "ggridges", "lme4", "performance", "sjPlot", "here", "emo", "broom.mixed"))
```


```{r setup, message = FALSE, warning = FALSE, include = FALSE}
library(tidyverse)
library(skimr)
library(ggridges)
library(lmerTest)
library(performance)
library(sjPlot)
library(broom.mixed)
library(googlesheets4)
library(stringi)
library(gt)
library(ggbeeswarm)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
theme_set(theme_light())
```

```{css}
.main-container {
    max-width: 100%;
}
```

The following analysis report contains the descriptive and inferential statistics for the experiment that investigated how physiological and subjective arousal might be mediated by cardioceptive accuracy.

```{r data_read, include = FALSE}

experiment_data_raw <- 
  googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19AcUrnOCxCH_Huu1yQ4JjEuJWljFRzhFQPYIGU1nhj0/edit#gid=57027312") %>% 
  janitor::clean_names() %>% 
  mutate(code = as.character(code))

phys_data <- read_csv(here::here("data/08_summarised/phys_long.csv"))

```


```{r}

experiment <-
  experiment_data_raw %>%
  rename(id = code) %>% 
  mutate(id = stri_trans_general(id, "Latin-ASCII") %>% 
              str_to_lower(),
         sex = recode(sex, `1` = "Male", `2` = "Female"),
         bodyweight = as.numeric(bodyweight),
         bmi = bodyweight / (bodyheight/100)^2) %>% 
  select(-starts_with("marker_"))
```

# Sample characteristics
```{r}

experiment %>% 
   select(id, sex, age, mental_order_1_2, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>% 
   mutate(male = if_else(sex == "Male", 1, 0),
          n = n()) %>% 
   summarise(across(c(n, male, age, stai_s_t0_sum, bmi, bodyfat_percent, resting_hr), 
                    list("_avg" = mean, "_sd" = sd, "_min" = min, "_max" = max), 
                    na.rm = TRUE)) %>% 
   pivot_longer(everything(),
                names_to = c(".value", "parameter"),
                names_pattern = "(.*)__(.*)$") %>% 
   pivot_longer(-parameter) %>% 
   pivot_wider(names_from = "parameter") %>% 
   mutate(avg = if_else(name %in% c("male"), avg * 100, avg),
          sd = if_else(name %in% c("n", "male"), NA_real_, sd),
          min = if_else(name %in% c("n", "male"), NA_real_, min),
          max = if_else(name %in% c("n", "male"), NA_real_, max),
          name = c("N", "Male %", "Mean age in years", "Mean STAI-S Baseline", "Mean BMI in kg/m<sup>2</sup>", "Mean Bodyfat %", "Mean resting HR in bpm")
          ) %>% 
   gt() %>% 
   fmt_number(2:5, decimals = 1, rows = 2:7) %>% 
   fmt_markdown(columns = 1) %>% 
   fmt_missing(everything(), missing_text = "-") %>% 
   cols_merge(columns = c("avg", "sd"), pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("min", "max"), pattern = "{1}-{2}") %>% 
   cols_label("name" = "", "avg" = "Value (SD)", "min" = "Range") %>%
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey")


experiment %>% 
   select(age, stai_s_t0_sum, bmi, bodyfat_percent, max_grip_strength, resting_hr) %>%
   pivot_longer(everything()) %>% 
   ggplot() +
   aes(x = value, fill = name) +
   geom_histogram(show.legend = FALSE) +
   facet_wrap(~name, scales = "free") +
   labs(title = "Histograms of participant characteristics")

```


# Subjective response to stress

We tested if the tasks were perceived as stressful.  

## STAI-S

Controlling  for the baseline level of anxiety (measured in the beginning of the session) and the order of the tasks, we found a significant interaction of task and measurement, i.e. the mental task was associated with a STAI-S increase over time, while the physical task did not show a significant change.

```{r}

stai <-
   experiment %>% 
   select(id, ends_with("_sum"), mental_order_1_2) %>% 
   pivot_longer(cols = -c(id, stai_s_t0_sum, mental_order_1_2)) %>% 
   extract(name, 
           into = c("task", "time"), 
           regex = "stai_s_(.*)_(.*)_sum") %>% 
   mutate(task = str_to_title(task))

stai_sum <- 
   stai %>% 
   group_by(task, time) %>% 
   summarise(stai_avg = mean(value, na.rm = TRUE),
             stai_sd = sd(value, na.rm = TRUE),
             stai_se = stai_sd/sqrt(n()),
             .groups = "drop")

```

```{r}
# Table
stai_sum %>% 
   select(-stai_se) %>% 
   pivot_wider(names_from = c(time), names_sep = "_",
               values_from = c(stai_avg, stai_sd)) %>% 
   gt() %>% 
   fmt_number(columns = starts_with("stai_"), 
                 decimals = 1) %>% 
   cols_merge(columns = c("stai_avg_t0", "stai_sd_t0"), 
              pattern = "{1} ({2})") %>% 
   cols_merge(columns = c("stai_avg_t1", "stai_sd_t1"), 
              pattern = "{1} ({2})") %>% 
   cols_label(task = "Task",
              stai_avg_t0 = "Pre-stress", 
              stai_avg_t1 = "Post-stress") %>% 
   tab_options(column_labels.font.weight = "bold",
               column_labels.background.color = "lightgrey") %>% 
   tab_footnote(footnote = "Values represent the mean (SD) of the STAI-S",
                locations = cells_column_labels(3))

```

---
<div align="center">
```{r}
# Stats
stai %>% 
   filter(task != "baseline") %>% 
   lmer(value ~ task * time + stai_s_t0_sum + mental_order_1_2 + (1|id), 
        data = .) %>% 
   tab_model(dv.labels = "STAI-S", 
             pred.labels = c("Task:Physical", 
                             "Time:Post", 
                             "STAI-S Baseline", 
                             "Task order",
                             "Task:Physical * Time:Post"
                             ))
```
</div>

---

```{r}
# Visualize
stai_sum %>% 
   ggplot() +
   aes(x = time, y = stai_avg, group = task, color = task,
       ymin = stai_avg - stai_se, ymax = stai_avg + stai_se) +
   geom_pointrange() +
   geom_line(size = 1.2, alpha = .6) +
   scale_y_continuous(limits = c(0, NA)) +
   labs(color = "Task",
        title = "Change in STAI-S by task and time",
        subtitle = "STAI-S increased only in the mental stress task. Error bars represent standard errors.")


```

## Subjective stress (VAS)

Most of the participants regarded the mental stress more stressful than the physical stress.

```{r}
experiment %>% 
   select(id, mental_experienced_stress, physical_experienced_stress) %>% 
   pivot_longer(-id) %>% 
   mutate(name = str_remove(name, "_experienced_stress")) %>% 
   ggplot() +
   aes(x = value, y = name) +
   geom_violin(aes(fill = name), alpha = .8, show.legend = FALSE) +
   geom_line(aes(group = id), alpha = .2) +
   geom_boxplot(show.legend = FALSE, width = .25, outlier.alpha = 0, alpha = .6) +
   geom_quasirandom(groupOnX = FALSE) +
   labs(y = NULL, 
        x = "On a scale of 0-100, how stressful was the task for you?",
        title = "Distribution of Experienced stress by task",
        subtitle = "Physical stress was percieved as less stressful.")

```

# Psychophysiological response to stress

```{r}

outliers <- 
   phys_data %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   group_by(name) %>% 
   mutate(outlier = if_else(abs(scale(value)) > 3.5, TRUE, FALSE),
          .before = value) %>% 
   ungroup()

outliers %>% 
   ggplot() +
   aes(x = value, fill = outlier) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   scale_fill_manual(values = c("lightblue", "red")) +
   labs(x = NULL, y = NULL,
        title = "Histogram of the physiological variables",
        subtitle = "Outliers (red) are identified as values outside of 3.5 SD")


```

# Data cleaning

We remove outliers (values outside of 3.5 SD), and apply natural log transformation on the values. Values show that the increase variables should be analyzed using a GLM with exponential distribution.

```{r}
phys_trans <-
   outliers %>% 
   group_by(name, id) %>% 
   mutate(lg = log(value + 1),
          std = scale(value) %>% as.numeric(),
          stdlg = scale(lg) %>% as.numeric()) %>% 
   ungroup() %>% 
   pivot_wider(names_from = "name",
               values_from = value:stdlg) %>% 
   set_names(str_remove(names(.), "value_"))

phys_std %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   ggplot() +
   aes(x = value) +
   geom_histogram() +
   facet_wrap(~name, scales = "free") +
   labs(x = NULL, y = NULL,
        title = "Histogram of the log transformed physiological variables",
        subtitle = "Outliers have been removed")

# Standardize within person

phys_std <-
   phys_data %>% 
   pivot_longer(eda_avg:hf_abs) %>% 
   group_by(id, name) %>% 
   mutate(value = scale(value) %>% as.numeric()) %>% 
   pivot_wider(names_from = "name", values_from = "value")
   

lmer(stdlg_eda_increase ~ marker + (1|id), data = phys_trans) %>% 
   summary()
   
lmer(stdlg_rmssd ~ marker + (1|id), data = phys_trans) %>% 
   summary()

lmer(std_hf_percent ~ marker + (1|id), data = phys_trans) %>% 
   summary()


lmer(stdlg_meanhr ~ marker + (1|id), data = phys_trans) %>% 
   summary()


```

# Physiological response to stress

```{r}
phys_std %>% 
   select(id:recordingtime_s, eda_increase, rmssd, hr)
```


## Electrodermal response

```{r}
# TODO: estimates are not shown properly
edai_mod <- 
      glmer(I(eda_increase+1) ~ marker + (1|id),
            family = Gamma(link = "log"), 
            data = phys_data)

summary(edai_mod)
tab_model(edai_mod)

lmer(scr_avg ~ marker + (1|id), data = phys_log) %>% 
   summary()

```

## Heart Rate and Heart rate variability (HRV)

We use the log transformed HR, RMSSD and HF


### HR
```{r}
hr_mod <- lmer(meanhr ~ marker + (1|id), data = phys_log)
   
summary(hr_mod)
   
```

### RMSSD
```{r}
rmssd_mod <- lmer(rmssd ~ marker + (1|id), data = phys_log)
   
summary(rmssd_mod)
   
```

### HF
```{r}
hf_mod <- lmer(hf_percent ~ marker + (1|id), data = phys_log)
   
summary(hf_mod)
   
```

